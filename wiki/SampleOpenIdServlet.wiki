#labels sample,openid,servlet
A sample openid servlet using dyuproject-openid

The source is available [http://dyuproject.googlecode.com/svn/trunk/modules/demos/openid-servlet/ here].

Here's the [http://dp-openid.morphexchange.com/home/ live demo]

{{{openid.properties}}}
{{{
openid.cookie.name=openidservlet
openid.cookie.security.secretKey=secret
openid.cookie.path=/
}}}

{{{web.xml}}}
{{{
<?xml version="1.0" encoding="ISO-8859-1"?>
<web-app 
   xmlns="http://java.sun.com/xml/ns/javaee" 
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" 
   version="2.5" metadata-complete="true">
   
  <servlet>
    <servlet-name>home-servlet</servlet-name>
    <servlet-class>com.dyuproject.demos.openidservlet.HomeServlet</servlet-class>	
  </servlet>

  <servlet-mapping>
    <servlet-name>home-servlet</servlet-name>
    <url-pattern>/home/</url-pattern>
  </servlet-mapping>  
  
  <servlet>
    <servlet-name>logout-servlet</servlet-name>
    <servlet-class>com.dyuproject.demos.openidservlet.LogoutServlet</servlet-class>	
  </servlet>

  <servlet-mapping>
    <servlet-name>logout-servlet</servlet-name>
    <url-pattern>/logout/</url-pattern>
  </servlet-mapping>
    
</web-app>
}}}

{{{HomeServlet.java}}}
{{{

package com.dyuproject.demos.openidservlet;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.dyuproject.openid.OpenIdUser;
import com.dyuproject.openid.RelyingParty;

/**
 * Home Servlet. If a user is authenticated, he/she gets forwarded to the login page. 
 * 
 * @author David Yu
 */
@SuppressWarnings("serial")
public class HomeServlet extends HttpServlet
{
    
    RelyingParty _relyingParty;
    
    public void init()
    {
        _relyingParty = RelyingParty.getInstance();
    }    
    
    public void doGet(HttpServletRequest request, HttpServletResponse response)
    throws IOException, ServletException
    {
        doPost(request, response);
    }
    
    public void doPost(HttpServletRequest request, HttpServletResponse response)
    throws IOException, ServletException
    {        
        try
        {
            OpenIdUser user = _relyingParty.discover(request);
            if(user==null)
            {
                // new user                
                request.getRequestDispatcher("/login.jsp").forward(request, response);
                return;
            }
            
            if(user.isAuthenticated())
            {
                // user already authenticated                
                request.setAttribute("user", user);
                request.getRequestDispatcher("/home.jsp").forward(request, response);
                
                return;
            }
            
            if(user.isAssociated() && RelyingParty.isAuthResponse(request))
            {
                // verify authentication
                if(_relyingParty.verifyAuth(user, request, response))
                {
                    // authenticated                    
                    // redirect to home to remove the query params instead of doing:
                    // request.setAttribute("user", user); request.getRequestDispatcher("/home.jsp").forward(request, response);
                    response.sendRedirect("/home/");
                }
                else
                {
                    // failed verification ... re-authenticate
                    request.getRequestDispatcher("/login.jsp").forward(request, response);
                }
                return;
            }
            
            // associate user
            if(_relyingParty.associate(user, request, response))
            {
                // authenticate user to his/her openid provider
                StringBuffer url = request.getRequestURL();
                String trustRoot = url.substring(0, url.indexOf("/", 9));
                String realm = url.substring(0, url.lastIndexOf("/"));
                String returnTo = url.toString();
                response.sendRedirect(RelyingParty.getAuthUrlString(user, trustRoot, realm, 
                        returnTo)); 
            }
            else
            {
                // failed association
                request.getRequestDispatcher("/login.jsp").forward(request, response);
            }           
        }
        catch(Exception e)
        {
            e.printStackTrace();
            response.sendError(401);
        }
    }

}


}}}




{{{LogoutServlet.java}}}

{{{

package com.dyuproject.demos.openidservlet;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.dyuproject.openid.RelyingParty;

/**
 * Logout Servlet
 * 
 * @author David Yu
 */
@SuppressWarnings("serial")
public class LogoutServlet extends HttpServlet
{
    
    public void doGet(HttpServletRequest request, HttpServletResponse response)
    throws IOException, ServletException
    {
        doPost(request, response);
    }
    
    public void doPost(HttpServletRequest request, HttpServletResponse response)
    throws IOException, ServletException
    {
        RelyingParty.getInstance().invalidate(response);
        response.sendRedirect("/home/");
    }

}


}}}